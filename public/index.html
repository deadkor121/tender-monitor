<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–µ–Ω–¥–µ—Ä–æ–≤ - –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –ù–æ—Ä–≤–µ–≥–∏—è</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–µ–Ω–¥–µ—Ä–æ–≤ –∏–∑ –ù–æ—Ä–≤–µ–≥–∏–∏ –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É –¥–æ 1 –º–ª–Ω NOK">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tender Monitor">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        header {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        h1 { color: #fff; font-size: 2.2em; margin-bottom: 8px; }
        .subtitle { color: #aaa; font-size: 1em; }

        /* --- –ü–∞–Ω–µ–ª—å —Å–∞–π—Ç–æ–≤ --- */
        .sources-panel {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .sources-panel h3 { color: #fff; margin-bottom: 15px; font-size: 1.1em; }

        .sources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .source-card {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            padding: 18px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .source-card:hover { border-color: #667eea; }
        .source-card.disabled { opacity: 0.5; }

        .source-info h4 { color: #fff; margin-bottom: 4px; }
        .source-info .source-url { color: #888; font-size: 0.85em; }
        .source-info .source-status { font-size: 0.8em; margin-top: 4px; }
        .source-info .source-status.ok { color: #4CAF50; }
        .source-info .source-status.error { color: #f44336; }
        .source-info .source-status.pending { color: #ff9800; }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            cursor: pointer;
        }

        .toggle-switch input { display: none; }

        .toggle-slider {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #555;
            border-radius: 26px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            content: '';
            position: absolute;
            width: 20px; height: 20px;
            left: 3px; bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider { background: #4CAF50; }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); }

        /* --- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .stat-value { font-size: 2.2em; font-weight: bold; color: #667eea; margin-bottom: 5px; }
        .stat-value.urgent { color: #f44336; }
        .stat-value.warning { color: #ff9800; }
        .stat-value.success { color: #4CAF50; }
        .stat-label { color: #888; font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; }
        
        /* –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã */
        .quick-filters {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 25px;
        }
        
        .quick-filters h3 {
            color: #fff;
            font-size: 0.95em;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .quick-filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .quick-filter-btn {
            background: rgba(102, 126, 234, 0.15);
            border: 2px solid rgba(102, 126, 234, 0.3);
            color: #a5b4fc;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .quick-filter-btn:hover {
            background: rgba(102, 126, 234, 0.25);
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .quick-filter-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: #fff;
        }
        
        .quick-filter-btn .count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .quick-filter-btn.active .count {
            background: rgba(255,255,255,0.3);
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è */
        .update-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 8px;
            font-size: 0.85em;
        }
        
        .update-indicator.loading {
            background: rgba(255, 152, 0, 0.1);
            border-color: rgba(255, 152, 0, 0.3);
        }
        
        .update-pulse {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .update-pulse.loading {
            background: #ff9800;
        }

        /* --- –ö–æ–Ω—Ç—Ä–æ–ª—ã --- */
        .controls {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled { background: #444; cursor: not-allowed; transform: none; box-shadow: none; }
        button.active { background: #4CAF50; }
        button.btn-orange { background: #ff9800; }
        button.btn-orange:hover { background: #e68a00; }

        select, input[type="text"] {
            padding: 10px 15px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            font-size: 0.95em;
            outline: none;
            background: rgba(255,255,255,0.08);
            color: #fff;
            transition: border-color 0.3s;
        }

        select:focus, input[type="text"]:focus { border-color: #667eea; }
        select option { background: #1a1a2e; color: #fff; }

        /* --- –¢–µ–Ω–¥–µ—Ä—ã --- */
        .tenders-container {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 15px;
        }

        .tender-item {
            border: 1px solid rgba(255,255,255,0.1);
            padding: 22px;
            margin-bottom: 15px;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.03);
        }

        .tender-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .tender-item.new { 
            border: 2px solid #4CAF50;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(76, 175, 80, 0.05) 100%);
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
            animation: newTenderPulse 2s ease-in-out infinite;
            position: relative;
        }

        @keyframes newTenderPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.3); }
            50% { box-shadow: 0 0 30px rgba(76, 175, 80, 0.5), 0 0 40px rgba(76, 175, 80, 0.2); }
        }

        .tender-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
            gap: 10px;
        }

        .tender-title { font-size: 1.2em; color: #fff; font-weight: 600; flex: 1; }

        .tender-badges { display: flex; gap: 8px; flex-shrink: 0; }

        .tender-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
        }

        /* NEW badge —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π */
        .tender-badge.new-badge {
            background: linear-gradient(135deg, #4CAF50, #45a049) !important;
            color: white !important;
            font-weight: 700 !important;
            box-shadow: 0 2px 10px rgba(76, 175, 80, 0.4);
            animation: badgePulse 1.5s ease-in-out infinite;
            padding: 5px 14px;
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }
        .tender-badge.source-badge { background: #667eea; color: white; }
        .tender-badge.source-badge.doffin { background: #ff9800; }
        .tender-badge.source-badge.ted { background: #2196F3; }
        .tender-badge.source-badge.mercell { background: #9C27B0; }
        .tender-badge.beginner { background: #00bcd4; color: white; }

        .tender-category {
            display: inline-block;
            background: rgba(102, 126, 234, 0.2);
            color: #97a8f0;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-bottom: 10px;
        }

        .tender-description { color: #aaa; line-height: 1.6; margin-bottom: 12px; font-size: 0.95em; }

        .tender-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.08);
            flex-wrap: wrap;
            gap: 10px;
        }

        .tender-date { 
            color: #aaa; 
            font-size: 0.9em; 
            line-height: 1.6;
        }

        .tender-date strong {
            color: #ccc;
        }

        .tender-link {
            background: #667eea;
            color: white;
            padding: 8px 18px;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9em;
        }

        .tender-link:hover { background: #5568d3; }

        .loading { text-align: center; padding: 40px; color: #888; }

        .spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 35px; height: 35px;
            animation: spin 1s linear infinite;
            margin: 15px auto;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .empty-state { text-align: center; padding: 50px 20px; }
        .empty-state-icon { font-size: 3.5em; margin-bottom: 15px; }
        .empty-state-text { color: #888; font-size: 1.1em; }

        .results-count { color: #888; font-size: 0.9em; padding: 10px 0; }
        
        /* === –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ === */
        
        /* –ò–∑–±—Ä–∞–Ω–Ω–æ–µ –∏ —Å—Ç–∞—Ç—É—Å—ã */
        .tender-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .btn-icon {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #aaa;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
        }
        
        .btn-icon:hover { background: rgba(255,255,255,0.15); color: #fff; }
        .btn-icon.active { background: #667eea; color: white; border-color: #667eea; }
        .btn-icon.favorite.active { background: #f44336; }
        
        /* –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏—è */
        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .pagination {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .pagination button {
            padding: 8px 12px;
            min-width: 40px;
        }
        
        .pagination button.active {
            background: #667eea;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: #1a1a2e;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-close {
            background: none;
            color: #aaa;
            font-size: 1.5em;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        
        /* –¢–µ–º—ã */
        body.light-theme {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
        }
        
        body.light-theme .tender-item,
        body.light-theme .stat-card,
        body.light-theme .sources-panel {
            background: rgba(255,255,255,0.9);
            color: #333;
        }
        
        body.light-theme .tender-title,
        body.light-theme h1, body.light-theme h3 {
            color: #1a1a2e;
        }
        
        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 100;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω */
        @media (max-width: 768px) {
            .controls { flex-direction: column; align-items: stretch; }
            .controls button, .controls select, .controls input { width: 100%; }
            .sources-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .tender-header { flex-direction: column; align-items: start; }
        }
        
        /* –ì—Ä–∞—Ñ–∏–∫–∏ */
        .chart-container {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .chart-label {
            width: 150px;
            font-size: 0.9em;
            color: #aaa;
        }
        
        .chart-bar-fill {
            height: 24px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        .chart-value {
            margin-left: 10px;
            color: #fff;
            font-weight: bold;
        }
        
        /* === –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π === */
        
        /* –¢–µ–≥–∏ */
        .tender-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin: 8px 0;
        }
        
        .tag {
            background: rgba(102, 126, 234, 0.2);
            color: #97a8f0;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .tag-remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.7;
        }
        
        .tag-remove:hover { opacity: 1; }
        
        .tag-input-container {
            position: relative;
            display: inline-block;
        }
        
        .tag-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            background: #1a1a2e;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            min-width: 200px;
            display: none;
        }
        
        .tag-suggestions.show { display: block; }
        
        .tag-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .tag-suggestion:hover {
            background: rgba(102, 126, 234, 0.3);
        }
        
        /* –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã */
        .priority-badge {
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: 600;
            display: inline-block;
        }
        
        .priority-badge.high {
            background: #f44336;
            color: white;
        }
        
        .priority-badge.medium {
            background: #ff9800;
            color: white;
        }
        
        .priority-badge.low {
            background: #4CAF50;
            color: white;
        }
        
        .tender-item.priority-high {
            border-left: 4px solid #f44336;
        }
        
        .tender-item.priority-medium {
            border-left: 4px solid #ff9800;
        }
        
        .tender-item.priority-low {
            border-left: 4px solid #4CAF50;
        }
        
        /* –°—Ä–æ—á–Ω–æ—Å—Ç—å –¥–µ–¥–ª–∞–π–Ω–∞ */
        .deadline-badge {
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .deadline-badge.urgent {
            background: #f44336;
            color: white;
            animation: pulse 2s infinite;
        }
        
        .deadline-badge.warning {
            background: #ff9800;
            color: white;
        }
        
        .deadline-badge.normal {
            background: rgba(255,255,255,0.1);
            color: #aaa;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã */
        .advanced-filters {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        
        .advanced-filters.show { display: block; }
        
        .filter-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            color: #aaa;
            font-size: 0.85em;
            margin-bottom: 5px;
        }
        
        .filter-group input[type="number"],
        .filter-group input[type="date"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.08);
            color: #fff;
        }
        
        .filter-presets {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .preset-btn {
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.4);
            color: #97a8f0;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
        }
        
        .preset-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è —Ç–µ–≥–æ–≤ –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π */
        .modal-input {
            width: 100%;
            padding: 10px 15px;
            margin: 10px 0;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.08);
            color: #fff;
            font-size: 1em;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .btn-secondary {
            background: #555;
        }
        
        .btn-secondary:hover {
            background: #666;
        }
        
        .reminder-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        .reminder-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .reminder-checkbox:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .reminder-checkbox input[type="checkbox"] {
            cursor: pointer;
        }
        
        /* PWA Install Button */
        .install-pwa {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        .install-pwa.show { display: block; }
        
        @keyframes slideIn {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .install-pwa:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        /* –°—á–µ—Ç—á–∏–∫ —Ç–µ–≥–æ–≤ */
        .filter-tag-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .filter-tag {
            background: rgba(102, 126, 234, 0.3);
            color: #fff;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-tag:hover {
            background: rgba(102, 126, 234, 0.5);
        }
        
        .filter-tag.active {
            background: #667eea;
        }
    </style>
    <script src="/socket.io/socket.io.js"></script>

</head>
<body>
    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã -->
    <div class="theme-toggle" onclick="toggleTheme()" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
        üåì
    </div>

    <div class="container">
        <header>
            <h1>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç–µ–Ω–¥–µ—Ä–æ–≤</h1>
            <p class="subtitle">–ù–æ—Ä–≤–µ–≥–∏—è | –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –¥–æ 1 –º–ª–Ω NOK | –ü–æ–¥—Ö–æ–¥—è—â–∏–µ –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤</p>
            <div class="update-indicator" id="updateIndicator">
                <div class="update-pulse"></div>
                <span id="lastUpdateText">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </header>

        <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ —Å–∞–π—Ç–æ–≤ -->
        <div class="sources-panel">
            <h3>–°–∞–π—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</h3>
            <div class="sources-grid" id="sourcesGrid">
                <!-- –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalTenders">0</div>
                <div class="stat-label">–í—Å–µ–≥–æ —Ç–µ–Ω–¥–µ—Ä–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-value success" id="newTenders">0</div>
                <div class="stat-label">–ù–æ–≤—ã—Ö (48—á)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value urgent" id="urgentTenders">0</div>
                <div class="stat-label">–°—Ä–æ—á–Ω—ã—Ö (&lt;3–¥)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value warning" id="warningTenders">0</div>
                <div class="stat-label">–ü—Ä–µ–¥—É–ø—Ä. (&lt;7–¥)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="favoriteTenders">0</div>
                <div class="stat-label">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã—Ö</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalRuns">0</div>
                <div class="stat-label">–ü—Ä–æ–≤–µ—Ä–æ–∫</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="lastCheck">--</div>
                <div class="stat-label">–ü–æ—Å–ª. –ø—Ä–æ–≤–µ—Ä.</div>
            </div>
        </div>
        
        <!-- –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
        <div class="quick-filters">
            <h3>‚ö° –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</h3>
            <div class="quick-filter-buttons">
                <button class="quick-filter-btn" onclick="quickFilter('urgent')" id="quickUrgent">
                    üî¥ –°—Ä–æ—á–Ω—ã–µ
                    <span class="count" id="countUrgent">0</span>
                </button>
                <button class="quick-filter-btn" onclick="quickFilter('new')" id="quickNew">
                    ‚ö° –ù–æ–≤—ã–µ
                    <span class="count" id="countNew">0</span>
                </button>
                <button class="quick-filter-btn" onclick="quickFilter('favorites')" id="quickFavorites">
                    ‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
                    <span class="count" id="countFavorites">0</span>
                </button>
                <button class="quick-filter-btn" onclick="quickFilter('warning')" id="quickWarning">
                    üü† –°–∫–æ—Ä–æ
                    <span class="count" id="countWarning">0</span>
                </button>
                <button class="quick-filter-btn" onclick="quickFilter('all')" id="quickAll">
                    üìã –í—Å–µ
                    <span class="count" id="countAll">0</span>
                </button>
            </div>
        </div>

        <div class="controls">
            <button onclick="loadTenders()" id="refreshBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <button onclick="scrapeNow()" id="scrapeBtn" class="btn-orange">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–π—á–∞—Å</button>
            <button onclick="showAnalytics()">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
            <button onclick="showFavorites()">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
            <div class="sort-controls">
                <select id="sortBy" onchange="applyFilters()">
                    <option value="date">–ü–æ –¥–∞—Ç–µ</option>
                    <option value="deadline">–ü–æ –¥–µ–¥–ª–∞–π–Ω—É</option>
                    <option value="title">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
                </select>
            </div>
            <select id="sourceFilter" onchange="applyFilters()">
                <option value="all">–í—Å–µ —Å–∞–π—Ç—ã</option>
                <option value="anbud">Anbud Direkte</option>
                <option value="doffin">Doffin.no</option>
                <option value="ted">TED Europa</option>
                <option value="mercell">Mercell</option>
            </select>
            <select id="timeFilter" onchange="applyFilters()">
                <option value="all">–í—Å–µ –≤—Ä–µ–º—è</option>
                <option value="24h">–ó–∞ 24 —á–∞—Å–∞</option>
                <option value="7d">–ó–∞ 7 –¥–Ω–µ–π</option>
            </select>
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." oninput="applyFilters()">
            <select id="exportFormat" onchange="exportData(this.value); this.value='';">
                <option value="">–≠–∫—Å–ø–æ—Ä—Ç...</option>
                <option value="excel">Excel (.xlsx)</option>
                <option value="csv">CSV</option>
                <option value="json">JSON</option>
            </select>
            <button onclick="toggleAdvancedFilters()">üîç –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫</button>
        </div>

        <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
        <div class="advanced-filters" id="advancedFilters">
            <h3 style="color: #fff; margin-bottom: 15px;">–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</h3>
            
            <div class="filter-row">
                <div class="filter-group">
                    <label>–¶–µ–Ω–∞ –æ—Ç (NOK):</label>
                    <input type="number" id="priceMin" placeholder="0" onchange="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>–¶–µ–Ω–∞ –¥–æ (NOK):</label>
                    <input type="number" id="priceMax" placeholder="1000000" onchange="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>–î–µ–¥–ª–∞–π–Ω –æ—Ç:</label>
                    <input type="date" id="deadlineFrom" onchange="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>–î–µ–¥–ª–∞–π–Ω –¥–æ:</label>
                    <input type="date" id="deadlineTo" onchange="applyFilters()">
                </div>
            </div>
            
            <div class="filter-row">
                <div class="filter-group">
                    <label>–°—Ä–æ—á–Ω–æ—Å—Ç—å:</label>
                    <select id="urgencyFilter" onchange="applyFilters()">
                        <option value="all">–í—Å–µ</option>
                        <option value="urgent">–°—Ä–æ—á–Ω—ã–µ (‚â§3 –¥–Ω–µ–π)</option>
                        <option value="warning">–°–∫–æ—Ä–æ (‚â§7 –¥–Ω–µ–π)</option>
                        <option value="normal">–û–±—ã—á–Ω—ã–µ (>7 –¥–Ω–µ–π)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</label>
                    <select id="priorityFilter" onchange="applyFilters()">
                        <option value="all">–í—Å–µ</option>
                        <option value="high">–í—ã—Å–æ–∫–∏–π</option>
                        <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
                        <option value="low">–ù–∏–∑–∫–∏–π</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>–¢–µ–≥–∏:</label>
                    <div class="filter-tag-list" id="filterTagList">
                        <span style="color: #aaa; font-size: 0.85em;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–≥–æ–≤...</span>
                    </div>
                </div>
            </div>
            
            <div class="filter-presets">
                <span style="color: #aaa; margin-right: 10px;">–ü—Ä–µ—Å–µ—Ç—ã:</span>
                <button class="preset-btn" onclick="loadPreset('urgent')">‚ö° –°—Ä–æ—á–Ω—ã–µ</button>
                <button class="preset-btn" onclick="loadPreset('highPriority')">üî¥ –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</button>
                <button class="preset-btn" onclick="loadPreset('recent')">üÜï –ù–æ–≤—ã–µ –∑–∞ 24—á</button>
                <button class="preset-btn" onclick="saveCurrentPreset()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π</button>
                <button class="preset-btn" onclick="resetFilters()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
        </div>

        <div class="tenders-container">
            <div class="results-count" id="resultsCount"></div>
            <div id="tendersContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ -->
    <div id="analyticsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
                <button class="modal-close" onclick="closeModal('analyticsModal')">√ó</button>
            </div>
            <div id="analyticsContent">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ -->
    <div id="favoritesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2>
                <button class="modal-close" onclick="closeModal('favoritesModal')">√ó</button>
            </div>
            <div id="favoritesContent">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>
    </div>

    <script>
        let allTenders = [];
        let sources = [];
        let favorites = {};
        let currentPage = 1;
        let itemsPerPage = 20;
        let socket;
        let activeQuickFilter = null; // –ê–∫—Ç–∏–≤–Ω—ã–π –±—ã—Å—Ç—Ä—ã–π —Ñ–∏–ª—å—Ç—Ä
        let lastUpdateTime = null; // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

        // WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        function initWebSocket() {
            socket = io();
            socket.on('connect', () => console.log('[WebSocket] –ü–æ–¥–∫–ª—é—á–µ–Ω–æ'));
            socket.on('newTenders', (data) => {
                console.log('[WebSocket] –ù–æ–≤—ã–µ —Ç–µ–Ω–¥–µ—Ä—ã!', data);
                showNotification(`–ù–∞–π–¥–µ–Ω–æ ${data.count} –Ω–æ–≤—ã—Ö —Ç–µ–Ω–¥–µ—Ä–æ–≤!`);
                loadTenders();
            });
        }

        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showNotification(message) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–µ–Ω–¥–µ—Ä–æ–≤', { body: message, icon: '/favicon.ico' });
            }
            // –ó–≤—É–∫–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            playNotificationSound();
        }

        function playNotificationSound() {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZTRQSX6fi8LJWJBU='); audio.play().catch(() => {});
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        async function loadFavorites() {
            try {
                const response = await fetch('/api/favorites');
                const data = await response.json();
                if (data.success) favorites = data.favorites;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', error);
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            localStorage.setItem('theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º—ã –∏–∑ localStorage
        function loadTheme() {
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.add('light-theme');
            }
        }

        // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        function showModal(id) {
            document.getElementById(id).classList.add('show');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
        async function showAnalytics() {
            showModal('analyticsModal');
            try {
                const response = await fetch('/api/analytics');
                const data = await response.json();
                if (data.success) {
                    displayAnalytics(data.analytics);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', error);
            }
        }

        function displayAnalytics(analytics) {
            const container = document.getElementById('analyticsContent');
            container.innerHTML = `
                <div class="chart-container">
                    <h3>–í—Å–µ–≥–æ —Ç–µ–Ω–¥–µ—Ä–æ–≤: ${analytics.total}</h3>
                </div>
                
                <div class="chart-container">
                    <h3>–ü–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º</h3>
                    ${analytics.bySource.map(item => `
                        <div class="chart-bar">
                            <div class="chart-label">${item.source}</div>
                            <div class="chart-bar-fill" style="width: ${(item.count / analytics.total) * 100}%"></div>
                            <div class="chart-value">${item.count}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="chart-container">
                    <h3>–¢–æ–ø 10 –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h3>
                    ${analytics.byCategory.map(item => `
                        <div class="chart-bar">
                            <div class="chart-label">${item.category}</div>
                            <div class="chart-bar-fill" style="width: ${(item.count / analytics.total) * 100}%"></div>
                            <div class="chart-value">${item.count}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
        async function showFavorites() {
            showModal('favoritesModal');
            await loadFavorites();
            const container = document.getElementById('favoritesContent');
            const favList = Object.values(favorites);
            
            if (favList.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚≠ê</div><p class="empty-state-text">–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ–Ω–¥–µ—Ä–æ–≤</p></div>';
                return;
            }
            
            container.innerHTML = favList.map(tender => createTenderHTML(tender, true)).join('');
        }

        async function toggleFavorite(tenderId, tender) {
            try {
                if (favorites[tenderId]) {
                    await fetch(`/api/favorites/${tenderId}`, { method: 'DELETE' });
                    delete favorites[tenderId];
                } else {
                    await fetch(`/api/favorites/${tenderId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tender })
                    });
                    favorites[tenderId] = tender;
                }
                
                applyFilters(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫
                
                // –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ, –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
                const modal = document.getElementById('favoritesModal');
                if (modal && modal.classList.contains('show')) {
                    const container = document.getElementById('favoritesContent');
                    const favList = Object.values(favorites);
                    
                    if (favList.length === 0) {
                        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚≠ê</div><p class="empty-state-text">–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ–Ω–¥–µ—Ä–æ–≤</p></div>';
                    } else {
                        container.innerHTML = favList.map(tender => createTenderHTML(tender, true)).join('');
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        async function setStatus(tenderId, status) {
            try {
                await fetch(`/api/status/${tenderId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        // –≠–∫—Å–ø–æ—Ä—Ç
        async function exportData(format) {
            if (!format) return;
            const source = document.getElementById('sourceFilter').value;
            window.open(`/api/export/${format}?source=${source}`, '_blank');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∞–π—Ç–æ–≤
        async function loadSources() {
            try {
                const response = await fetch('/api/sources');
                const data = await response.json();
                if (data.success) {
                    sources = data.sources;
                    renderSources();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∞–π—Ç–æ–≤:', error);
            }
        }

        function renderSources() {
            const grid = document.getElementById('sourcesGrid');
            grid.innerHTML = sources.map(s => `
                <div class="source-card ${s.enabled ? '' : 'disabled'}">
                    <div class="source-info">
                        <h4>${escapeHtml(s.name)}</h4>
                        <div class="source-url">${escapeHtml(s.url)} ${s.requiresLogin ? '(login)' : '(open)'}</div>
                        <div class="source-desc" style="color:#888;font-size:0.8em;margin-top:2px;">${escapeHtml(s.description || '')}</div>
                        <div class="source-status pending" id="status-${s.id}">${s.enabled ? '–û–∂–∏–¥–∞–Ω–∏–µ...' : '–û—Ç–∫–ª—é—á–µ–Ω'}</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" ${s.enabled ? 'checked' : ''} onchange="toggleSource('${s.id}', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            `).join('');
        }

        async function toggleSource(sourceId, enabled) {
            try {
                const body = {};
                body[sourceId] = enabled;
                await fetch('/api/sources', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                await loadSources();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–Ω–¥–µ—Ä–æ–≤
        async function loadTenders() {
            try {
                const btn = document.getElementById('refreshBtn');
                btn.disabled = true;
                btn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

                const response = await fetch('/api/tenders?source=all');
                const data = await response.json();

                if (data.success) {
                    allTenders = data.tenders;
                    lastUpdateTime = new Date(); // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
                    currentPage = 1; // –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
                    applyFilters();
                    updateStats();
                    updateIndicator();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                document.getElementById('tendersContent').innerHTML =
                    '<div class="empty-state"><div class="empty-state-icon">!</div><p class="empty-state-text">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p></div>';
            } finally {
                const btn = document.getElementById('refreshBtn');
                btn.disabled = false;
                btn.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
            }
        }

        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                if (data.success) {
                    const stats = data.stats;
                    
                    // –ü–æ–¥—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫ –∏–∑ allTenders
                    const newCount = allTenders.filter(t => isNew(t)).length;
                    const urgentCount = allTenders.filter(t => getUrgencyLevel(t.deadline) === 'urgent' && !isExpired(t)).length;
                    const warningCount = allTenders.filter(t => getUrgencyLevel(t.deadline) === 'warning' && !isExpired(t)).length;
                    const favoriteCount = Object.keys(favorites).length;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                    document.getElementById('totalTenders').textContent = allTenders.filter(t => !isExpired(t)).length;
                    document.getElementById('newTenders').textContent = newCount;
                    document.getElementById('urgentTenders').textContent = urgentCount;
                    document.getElementById('warningTenders').textContent = warningCount;
                    document.getElementById('favoriteTenders').textContent = favoriteCount;
                    document.getElementById('totalRuns').textContent = stats.totalRuns;

                    if (stats.lastRun) {
                        lastUpdateTime = new Date(stats.lastRun);
                        updateIndicator();
                        const diff = Math.floor((new Date() - new Date(stats.lastRun)) / 60000);
                        document.getElementById('lastCheck').textContent = diff < 1 ? '–°–µ–π—á–∞—Å' : `${diff} –º–∏–Ω`;
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã —Å–∞–π—Ç–æ–≤
                    if (stats.bySite) {
                        Object.entries(stats.bySite).forEach(([id, site]) => {
                            const el = document.getElementById(`status-${id}`);
                            if (el && site.lastStatus) {
                                el.className = `source-status ${site.lastStatus}`;
                                el.textContent = site.lastStatus === 'ok'
                                    ? `OK | –ù–∞–π–¥–µ–Ω–æ: ${site.newTenders}`
                                    : '–û—à–∏–±–∫–∞';
                            }
                        });
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –±—ã—Å—Ç—Ä—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
                    updateQuickFilterCounts();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –±—ã—Å—Ç—Ä—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function updateQuickFilterCounts() {
            const urgentCount = allTenders.filter(t => getUrgencyLevel(t.deadline) === 'urgent' && !isExpired(t)).length;
            const newCount = allTenders.filter(t => isNew(t) && !isExpired(t)).length;
            const favoriteCount = Object.keys(favorites).length;
            const warningCount = allTenders.filter(t => getUrgencyLevel(t.deadline) === 'warning' && !isExpired(t)).length;
            const allCount = allTenders.filter(t => !isExpired(t)).length;
            
            document.getElementById('countUrgent').textContent = urgentCount;
            document.getElementById('countNew').textContent = newCount;
            document.getElementById('countFavorites').textContent = favoriteCount;
            document.getElementById('countWarning').textContent = warningCount;
            document.getElementById('countAll').textContent = allCount;
        }
        
        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        function updateIndicator() {
            const indicator = document.getElementById('updateIndicator');
            const text = document.getElementById('lastUpdateText');
            const pulse = indicator.querySelector('.update-pulse');
            
            if (!lastUpdateTime) {
                text.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...';
                return;
            }
            
            const now = new Date();
            const diffMs = now - lastUpdateTime;
            const diffMin = Math.floor(diffMs / 60000);
            const nextUpdateMin = 30 - (diffMin % 30);
            
            if (diffMin < 1) {
                text.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ | –°–ª–µ–¥. —á–µ—Ä–µ–∑ ' + nextUpdateMin + ' –º–∏–Ω';
            } else if (diffMin < 60) {
                text.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ ${diffMin} –º–∏–Ω. –Ω–∞–∑–∞–¥ | –°–ª–µ–¥. —á–µ—Ä–µ–∑ ${nextUpdateMin} –º–∏–Ω`;
            } else {
                const hours = Math.floor(diffMin / 60);
                text.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ ${hours} —á. –Ω–∞–∑–∞–¥ | –°–ª–µ–¥. —á–µ—Ä–µ–∑ ${nextUpdateMin} –º–∏–Ω`;
            }
        }
        
        // –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
        function quickFilter(type) {
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));
            
            if (activeQuickFilter === type) {
                // –û—Ç–∫–ª—é—á–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ —Ç–æ—Ç –∂–µ
                activeQuickFilter = null;
            } else {
                activeQuickFilter = type;
                document.getElementById('quick' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('active');
            }
            
            applyFilters();
        }

        async function scrapeNow() {
            const btn = document.getElementById('scrapeBtn');
            const indicator = document.getElementById('updateIndicator');
            btn.disabled = true;
            btn.textContent = '–ó–∞–ø—É—â–µ–Ω–æ...';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            indicator.classList.add('loading');

            try {
                await fetch('/api/scrape-now', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    loadTenders();
                    loadSources();
                    btn.disabled = false;
                    btn.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–π—á–∞—Å';
                    indicator.classList.remove('loading');
                }, 30000);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                btn.disabled = false;
                btn.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–π—á–∞—Å';
                indicator.classList.remove('loading');
            }
        }

        function filterTenders() {
            applyFilters();
        }

        function applyFilters() {
            const sourceFilter = document.getElementById('sourceFilter').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const sortBy = document.getElementById('sortBy').value;
            
            // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            const priceMin = parseFloat(document.getElementById('priceMin')?.value) || 0;
            const priceMax = parseFloat(document.getElementById('priceMax')?.value) || Infinity;
            const urgencyFilter = document.getElementById('urgencyFilter')?.value || 'all';
            const priorityFilter = document.getElementById('priorityFilter')?.value || 'all';

            let filtered = allTenders;

            // –§–∏–ª—å—Ç—Ä –ø–æ —Å–∞–π—Ç—É
            if (sourceFilter !== 'all') {
                filtered = filtered.filter(t => (t.source || 'anbud') === sourceFilter);
            }

            // ‚ùå –§–∏–ª—å—Ç—Ä –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö —Ç–µ–Ω–¥–µ—Ä–æ–≤ (–°–ö–†–´–í–ê–ï–ú –í–°–ï –ü–†–û–°–†–û–ß–ï–ù–ù–´–ï)
            filtered = filtered.filter(t => !isExpired(t));

            // üöÄ –ë–´–°–¢–†–´–ï –§–ò–õ–¨–¢–†–´ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –æ–±—ã—á–Ω—ã–º–∏)
            if (activeQuickFilter) {
                switch (activeQuickFilter) {
                    case 'urgent':
                        filtered = filtered.filter(t => getUrgencyLevel(t.deadline) === 'urgent');
                        break;
                    case 'new':
                        filtered = filtered.filter(t => isNew(t));
                        break;
                    case 'favorites':
                        filtered = filtered.filter(t => favorites[t.id]);
                        break;
                    case 'warning':
                        filtered = filtered.filter(t => getUrgencyLevel(t.deadline) === 'warning');
                        break;
                    case 'all':
                        // –í—Å–µ —Ç–µ–Ω–¥–µ—Ä—ã (–±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞)
                        break;
                }
            }

            // –§–∏–ª—å—Ç—Ä –ø–æ –≤—Ä–µ–º–µ–Ω–∏
            if (timeFilter === '24h') {
                const cutoff = new Date(Date.now() - 24 * 60 * 60 * 1000);
                filtered = filtered.filter(t => new Date(t.scrapedAt) > cutoff);
            } else if (timeFilter === '7d') {
                const cutoff = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                filtered = filtered.filter(t => new Date(t.scrapedAt) > cutoff);
            }

            // –§–∏–ª—å—Ç—Ä –ø–æ–∏—Å–∫–∞
            if (searchTerm) {
                filtered = filtered.filter(t =>
                    (t.title || '').toLowerCase().includes(searchTerm) ||
                    (t.description || '').toLowerCase().includes(searchTerm) ||
                    (t.category || '').toLowerCase().includes(searchTerm)
                );
            }
            
            // –§–∏–ª—å—Ç—Ä –ø–æ —Ü–µ–Ω–µ (–µ—Å–ª–∏ –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ü–µ–Ω–µ)
            if (priceMin > 0 || priceMax < Infinity) {
                filtered = filtered.filter(t => {
                    // –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å —Ü–µ–Ω—É –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è (–ø—Ä–∏–º–µ—Ä–Ω–∞—è –ª–æ–≥–∏–∫–∞)
                    // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –ø–∞—Ä—Å–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    return true; // placeholder
                });
            }
            
            // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏
            if (urgencyFilter !== 'all') {
                filtered = filtered.filter(t => getUrgencyLevel(t.deadline) === urgencyFilter);
            }
            
            // –§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (—Ç—Ä–µ–±—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤, –ø–æ–∫–∞ —É–ø—Ä–æ—â–µ–Ω–Ω–æ)
            // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –≤—Å–µ—Ö —Ç–µ–Ω–¥–µ—Ä–æ–≤
            
            // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º
            if (selectedTagFilters.length > 0) {
                // –¢–∞–∫–∂–µ —Ç—Ä–µ–±—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–≥–æ–≤ –≤—Å–µ—Ö —Ç–µ–Ω–¥–µ—Ä–æ–≤
                // –ü–æ–∫–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            }

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ (NEW —Ç–µ–Ω–¥–µ—Ä—ã –≤—Å–µ–≥–¥–∞ —Å–≤–µ—Ä—Ö—É)
            filtered.sort((a, b) => {
                const aIsNew = isNew(a);
                const bIsNew = isNew(b);
                
                // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø—Ä–∏–∑–Ω–∞–∫—É "–Ω–æ–≤—ã–π"
                if (aIsNew && !bIsNew) return -1;
                if (!aIsNew && bIsNew) return 1;
                
                // –ó–∞—Ç–µ–º –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∫—Ä–∏—Ç–µ—Ä–∏—é
                if (sortBy === 'date') {
                    return new Date(b.scrapedAt) - new Date(a.scrapedAt);
                } else if (sortBy === 'deadline') {
                    if (!a.deadline) return 1;
                    if (!b.deadline) return -1;
                    return new Date(a.deadline) - new Date(b.deadline);
                } else if (sortBy === 'title') {
                    return (a.title || '').localeCompare(b.title || '');
                }
                return 0;
            });

            document.getElementById('resultsCount').textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ: ${Math.min(filtered.length, itemsPerPage)} –∏–∑ ${filtered.length}`;
            displayTenders(filtered);
        }

        function displayTenders(tenders) {
            const container = document.getElementById('tendersContent');

            if (tenders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128203;</div>
                        <p class="empty-state-text">–¢–µ–Ω–¥–µ—Ä—ã –ø–æ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –î–æ–∂–¥–∏—Ç–µ—Å—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.</p>
                    </div>`;
                return;
            }

            // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginated = tenders.slice(start, end);

            container.innerHTML = paginated.map(tender => createTenderHTML(tender)).join('');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
            if (tenders.length > itemsPerPage) {
                const totalPages = Math.ceil(tenders.length / itemsPerPage);
                let paginationHTML = '<div class="pagination">';
                
                if (currentPage > 1) {
                    paginationHTML += `<button onclick="changePage(${currentPage - 1})">‚Üê</button>`;
                }
                
                for (let i = 1; i <= Math.min(totalPages, 10); i++) {
                    paginationHTML += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                }
                
                if (currentPage < totalPages) {
                    paginationHTML += `<button onclick="changePage(${currentPage + 1})">‚Üí</button>`;
                }
                
                paginationHTML += '</div>';
                container.innerHTML += paginationHTML;
            }
        }

        function createTenderHTML(tender, isFavoriteModal = false) {
            const source = tender.source || 'anbud';
            const sourceNames = { anbud: 'Anbud', doffin: 'Doffin', ted: 'TED EU', mercell: 'Mercell' };
            const sourceName = sourceNames[source] || source;
            const isNewTender = isNew(tender);
            const isFav = !!favorites[tender.id];
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ä–æ—á–Ω–æ—Å—Ç—å –¥–µ–¥–ª–∞–π–Ω–∞
            const urgency = getUrgencyLevel(tender.deadline);
            const urgencyLabels = { urgent: 'üî¥ –°—Ä–æ—á–Ω–æ', warning: 'üü† –°–∫–æ—Ä–æ', normal: 'üü¢ –û–±—ã—á–Ω—ã–π' };
            
            // Placeholder –¥–ª—è —Ç–µ–≥–æ–≤ –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ (–∑–∞–≥—Ä—É–∑—è—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
            setTimeout(() => loadTenderExtendedData(tender.id), 100);

            return `
            <div class="tender-item ${isNewTender ? 'new' : ''}" id="tender-${tender.id}" data-priority="medium">
                <div class="tender-header">
                    <h3 class="tender-title">
                        ${isNewTender ? '<span style="color: #4CAF50; margin-right: 6px;">üåü</span>' : ''}${escapeHtml(tender.title)}
                    </h3>
                    <div class="tender-badges">
                        <span class="tender-badge source-badge ${source}">${sourceName}</span>
                        ${isNewTender ? '<span class="tender-badge new-badge">NEW</span>' : ''}
                        ${tender.deadline ? `<span class="deadline-badge ${urgency}">${urgencyLabels[urgency]}</span>` : ''}
                        <span class="priority-badge medium" id="priority-badge-${tender.id}">–°—Ä–µ–¥–Ω–∏–π</span>
                    </div>
                </div>
                ${tender.category ? `<span class="tender-category">${escapeHtml(tender.category)}</span>` : ''}
                
                <!-- –¢–µ–≥–∏ -->
                <div class="tender-tags" id="tags-${tender.id}">
                    <span style="color: #aaa; font-size: 0.8em;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–≥–æ–≤...</span>
                </div>
                
                ${tender.description ? `<p class="tender-description">${escapeHtml(tender.description.substring(0, 300))}</p>` : ''}
                
                <div class="tender-footer">
                    <div class="tender-date">
                        <div style="margin-bottom: 4px;">
                            üìÖ <strong>–î–æ–±–∞–≤–ª–µ–Ω:</strong> ${isNewTender ? `<span style="color: #4CAF50; font-weight: 600;">‚ú® ${getTimeAgo(tender.scrapedAt)}</span>` : formatDate(tender.scrapedAt)}
                        </div>
                        <div>
                            ${tender.deadline ? 
                                `‚è∞ <strong>Deadline:</strong> <span style="color: ${getUrgencyLevel(tender.deadline) === 'urgent' ? '#f44336' : getUrgencyLevel(tender.deadline) === 'warning' ? '#ff9800' : '#4CAF50'};">${formatDeadline(tender.deadline)}</span>` 
                                : '‚è∞ <strong>Deadline:</strong> <span style="color: #888;">–Ω–µ —É–∫–∞–∑–∞–Ω</span>'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        ${!isFavoriteModal ? `<button class="btn-icon favorite ${isFav ? 'active' : ''}" onclick="toggleFavorite('${tender.id}', ${JSON.stringify(tender).replace(/"/g, '&quot;')})" title="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ">
                            ${isFav ? '‚ù§Ô∏è' : 'ü§ç'}
                        </button>` : ''}
                        <button class="btn-icon" onclick="openTagsModal('${tender.id}')" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞–º–∏">üè∑Ô∏è –¢–µ–≥–∏</button>
                        <button class="btn-icon" onclick="openPriorityMenu('${tender.id}')" title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç">‚≠ê –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</button>
                        ${tender.deadline ? `<button class="btn-icon" onclick="openReminderModal('${tender.id}', '${tender.title}', '${tender.deadline}')" title="–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ">‚è∞ –ù–∞–ø–æ–º–Ω–∏—Ç—å</button>` : ''}
                        ${tender.link ? `<a href="${escapeHtml(tender.link)}" target="_blank" class="tender-link">–û—Ç–∫—Ä—ã—Ç—å &rarr;</a>` : ''}
                    </div>
                </div>
            </div>`;
        }

        function changePage(page) {
            currentPage = page;
            applyFilters();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function isNew(tender) {
            // –¢–µ–Ω–¥–µ—Ä —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–æ–≤—ã–º –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω –º–µ–Ω–µ–µ 48 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥
            return new Date(tender.scrapedAt) > new Date(Date.now() - 48 * 60 * 60 * 1000);
        }

        function isExpired(tender) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å—Ç–µ–∫ –ª–∏ deadline —Ç–µ–Ω–¥–µ—Ä–∞
            if (!tender.deadline) return false; // –ï—Å–ª–∏ deadline –Ω–µ —É–∫–∞–∑–∞–Ω, —Ç–µ–Ω–¥–µ—Ä –Ω–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω
            try {
                const deadline = new Date(tender.deadline);
                const now = new Date();
                return deadline < now; // Deadline –º–µ–Ω—å—à–µ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã = –ø—Ä–æ—Å—Ä–æ—á–µ–Ω
            } catch (e) {
                return false; // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã, —Å—á–∏—Ç–∞–µ–º –Ω–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–º
            }
        }

        function getTimeAgo(dateStr) {
            const now = new Date();
            const past = new Date(dateStr);
            const diffMs = now - past;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffHours < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (diffHours < 3) return `${diffHours} —á. –Ω–∞–∑–∞–¥ ‚ö°`;
            if (diffHours < 24) return `${diffHours} —á. –Ω–∞–∑–∞–¥`;
            if (diffDays === 1) return '–≤—á–µ—Ä–∞';
            if (diffDays < 7) return `${diffDays} –¥–Ω. –Ω–∞–∑–∞–¥`;
            return formatDate(dateStr);
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleString('ru-RU', {
                day: 'numeric', month: 'short', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function formatDeadline(deadlineStr) {
            if (!deadlineStr) return null;
            try {
                const date = new Date(deadlineStr);
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –≤–∞–ª–∏–¥–Ω–∞—è –¥–∞—Ç–∞
                if (isNaN(date.getTime())) return deadlineStr; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å –µ—Å–ª–∏ –Ω–µ –¥–∞—Ç–∞
                
                const now = new Date();
                const diffMs = date - now;
                const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                
                const dateFormatted = date.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
                
                if (diffDays < 0) return `${dateFormatted} (–ø—Ä–æ—Å—Ä–æ—á–µ–Ω)`;
                if (diffDays === 0) return `${dateFormatted} (—Å–µ–≥–æ–¥–Ω—è!)`;
                if (diffDays === 1) return `${dateFormatted} (–∑–∞–≤—Ç—Ä–∞!)`;
                if (diffDays <= 3) return `${dateFormatted} (—á–µ—Ä–µ–∑ ${diffDays} –¥–Ω.)`;
                if (diffDays <= 7) return `${dateFormatted} (—á–µ—Ä–µ–∑ ${diffDays} –¥–Ω.)`;
                return dateFormatted;
            } catch (e) {
                return deadlineStr; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // === –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
        
        // –°—Ä–æ—á–Ω–æ—Å—Ç—å –¥–µ–¥–ª–∞–π–Ω–∞
        function getUrgencyLevel(deadline) {
            if (!deadline) return 'normal';
            const now = new Date();
            const deadlineDate = new Date(deadline);
            const daysLeft = Math.ceil((deadlineDate - now) / (1000 * 60 * 60 * 24));
            
            if (daysLeft <= 3) return 'urgent';
            if (daysLeft <= 7) return 'warning';
            return 'normal';
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ç–µ–Ω–¥–µ—Ä–∞
        async function loadTenderExtendedData(tenderId) {
            try {
                const [tagsRes, priorityRes] = await Promise.all([
                    fetch(`/api/tags/${tenderId}`),
                    fetch(`/api/priority/${tenderId}`)
                ]);
                
                const tagsData = await tagsRes.json();
                const priorityData = await priorityRes.json();
                
                if (tagsData.success) {
                    renderTags(tenderId, tagsData.tags || []);
                }
                
                if (priorityData.success) {
                    updatePriorityDisplay(tenderId, priorityData.priority || 'medium');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ç–µ–Ω–¥–µ—Ä–∞:', error);
            }
        }
        
        function renderTags(tenderId, tags) {
            const container = document.getElementById(`tags-${tenderId}`);
            if (!container) return;
            
            if (tags.length === 0) {
                container.innerHTML = '<button class="btn-icon" onclick="openTagsModal(\'' + tenderId + '\')" style="font-size: 0.8em;">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥–∏</button>';
                return;
            }
            
            container.innerHTML = tags.map(tag =>
                `<span class="tag">${escapeHtml(tag)} <span class="tag-remove" onclick="removeTag('${tenderId}', '${tag}')">√ó</span></span>`
            ).join('') + `<button class="btn-icon" onclick="openTagsModal('${tenderId}')" style="font-size: 0.7em; padding: 2px 6px;">+</button>`;
        }
        
        function updatePriorityDisplay(tenderId, priority) {
            const badge = document.getElementById(`priority-badge-${tenderId}`);
            const tenderEl = document.getElementById(`tender-${tenderId}`);
            if (!badge || !tenderEl) return;
            
            const labels = { high: '–í—ã—Å–æ–∫–∏–π', medium: '–°—Ä–µ–¥–Ω–∏–π', low: '–ù–∏–∑–∫–∏–π' };
            badge.className = `priority-badge ${priority}`;
            badge.textContent = labels[priority];
            
            tenderEl.className = tenderEl.className.replace(/priority-\w+/g, '');
            tenderEl.classList.add(`priority-${priority}`);
            tenderEl.setAttribute('data-priority', priority);
        }
        
        // –¢–µ–≥–∏
        let currentTagTenderId = null;
        let allSystemTags = [];
        
        async function openTagsModal(tenderId) {
            currentTagTenderId = tenderId;
            showModal('tagsModal');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ç–µ–≥–∏
            const res = await fetch(`/api/tags/${tenderId}`);
            const data = await res.json();
            const currentTags = data.success ? (data.tags || []) : [];
            
            document.getElementById('currentTagsList').innerHTML =
                currentTags.map(tag => `<span class="tag">${escapeHtml(tag)} <span class="tag-remove" onclick="removeTagFromModal('${tag}')">√ó</span></span>`).join('') ||
                '<span style="color: #aaa;">–ù–µ—Ç —Ç–µ–≥–æ–≤</span>';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ç–µ–≥–∏ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫
            const allTagsRes = await fetch('/api/tags');
            const allTagsData = await allTagsRes.json();
            allSystemTags = allTagsData.success ? allTagsData.tags : [];
        }
        
        async function addTag() {
            const input = document.getElementById('newTagInput');
            const tag = input.value.trim();
            if (!tag || !currentTagTenderId) return;
            
            const res = await fetch(`/api/tags/${currentTagTenderId}`);
            const data = await res.json();
            const currentTags = data.success ? (data.tags || []) : [];
            
            if (!currentTags.includes(tag)) {
                currentTags.push(tag);
                await fetch(`/api/tags/${currentTagTenderId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tags: currentTags })
                });
                
                renderTags(currentTagTenderId, currentTags);
                openTagsModal(currentTagTenderId);
            }
            
            input.value = '';
        }
        
        async function removeTag(tenderId, tag) {
            const res = await fetch(`/api/tags/${tenderId}`);
            const data = await res.json();
            let tags = data.success ? (data.tags || []) : [];
            
            tags = tags.filter(t => t !== tag);
            await fetch(`/api/tags/${tenderId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tags })
            });
            
            renderTags(tenderId, tags);
        }
        
        async function removeTagFromModal(tag) {
            await removeTag(currentTagTenderId, tag);
            openTagsModal(currentTagTenderId);
        }
        
        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
        async function openPriorityMenu(tenderId) {
            const priorities = [
                { value: 'high', label: 'üî¥ –í—ã—Å–æ–∫–∏–π', color: '#f44336' },
                { value: 'medium', label: 'üü† –°—Ä–µ–¥–Ω–∏–π', color: '#ff9800' },
                { value: 'low', label: 'üü¢ –ù–∏–∑–∫–∏–π', color: '#4CAF50' }
            ];
            
            const choice = confirm('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:\n\n1 - –í—ã—Å–æ–∫–∏–π\n2 - –°—Ä–µ–¥–Ω–∏–π\n3 - –ù–∏–∑–∫–∏–π');
            let priority = null;
            
            if (choice) {
                const num = prompt('–í–≤–µ–¥–∏—Ç–µ 1, 2 –∏–ª–∏ 3:');
                if (num === '1') priority = 'high';
                else if (num === '2') priority = 'medium';
                else if (num === '3') priority = 'low';
            }
            
            if (priority) {
                await fetch(`/api/priority/${tenderId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ priority })
                });
                
                updatePriorityDisplay(tenderId, priority);
            }
        }
        
        // –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
        let currentReminderData = {};
        
        function openReminderModal(tenderId, title, deadline) {
            currentReminderData = { tenderId, title, deadline };
            showModal('reminderModal');
            document.getElementById('reminderTenderTitle').textContent = title;
            document.getElementById('reminderDeadline').textContent = `–î–µ–¥–ª–∞–π–Ω: ${deadline}`;
        }
        
        async function saveReminder() {
            const checkboxes = document.querySelectorAll('.reminder-checkbox input:checked');
            const daysBeforeList = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (daysBeforeList.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–µ–Ω—å –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è');
                return;
            }
            
            await fetch(`/api/reminders/${currentReminderData.tenderId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ daysBeforeList })
            });
            
            closeModal('reminderModal');
            alert(`–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∑–∞: ${daysBeforeList.join(', ')} –¥–Ω–µ–π –¥–æ –¥–µ–¥–ª–∞–π–Ω–∞`);
        }
        
        // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
        function toggleAdvancedFilters() {
            const panel = document.getElementById('advancedFilters');
            panel.classList.toggle('show');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–≥–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
            if (panel.classList.contains('show')) {
                loadFilterTags();
            }
        }
        
        async function loadFilterTags() {
            const res = await fetch('/api/tags');
            const data = await res.json();
            if (data.success) {
                const container = document.getElementById('filterTagList');
                const tags = data.tags;
                
                if (tags.length === 0) {
                    container.innerHTML = '<span style="color: #aaa; font-size: 0.85em;">–ù–µ—Ç —Ç–µ–≥–æ–≤</span>';
                    return;
                }
                
                container.innerHTML = tags.map(tag =>
                    `<span class="filter-tag" onclick="toggleTagFilter('${tag}')">${escapeHtml(tag)}</span>`
                ).join('');
            }
        }
        
        let selectedTagFilters = [];
        
        function toggleTagFilter(tag) {
            const index = selectedTagFilters.indexOf(tag);
            if (index > -1) {
                selectedTagFilters.splice(index, 1);
            } else {
                selectedTagFilters.push(tag);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ
            document.querySelectorAll('.filter-tag').forEach(el => {
                if (el.textContent === tag) {
                    el.classList.toggle('active');
                }
            });
            
            applyFilters();
        }
        
        function loadPreset(preset) {
            resetFilters();
            
            if (preset === 'urgent') {
                document.getElementById('urgencyFilter').value = 'urgent';
            } else if (preset === 'highPriority') {
                document.getElementById('priorityFilter').value = 'high';
            } else if (preset === 'recent') {
                document.getElementById('timeFilter').value = '24h';
            }
            
            applyFilters();
        }
        
        function saveCurrentPreset() {
            const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç–∞:');
            if (!name) return;
            
            const filters = {
                source: document.getElementById('sourceFilter').value,
                time: document.getElementById('timeFilter').value,
                search: document.getElementById('searchInput').value,
                priceMin: document.getElementById('priceMin').value,
                priceMax: document.getElementById('priceMax').value,
                urgency: document.getElementById('urgencyFilter').value,
                priority: document.getElementById('priorityFilter').value
            };
            
            fetch('/api/filter-presets', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, filters })
            });
            
            alert('–ü—Ä–µ—Å–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
        }
        
        function resetFilters() {
            document.getElementById('sourceFilter').value = 'all';
            document.getElementById('timeFilter').value = 'all';
            document.getElementById('searchInput').value = '';
            document.getElementById('sortBy').value = 'date';
            document.getElementById('priceMin').value = '';
            document.getElementById('priceMax').value = '';
            document.getElementById('urgencyFilter').value = 'all';
            document.getElementById('priorityFilter').value = 'all';
            selectedTagFilters = [];
            document.querySelectorAll('.filter-tag').forEach(el => el.classList.remove('active'));
            applyFilters();
        }
        
        // PWA
        let deferredPrompt;
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('[SW] Registered', reg))
                    .catch(err => console.log('[SW] Error', err));
            });
        }
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPWA').classList.add('show');
        });
        
        function installPWA() {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('PWA installed');
                }
                deferredPrompt = null;
                document.getElementById('installPWA').classList.remove('show');
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function initApp() {
            loadTheme();
            initWebSocket();
            loadSources();
            await loadFavorites(); // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
            await loadTenders();   // –ó–∞—Ç–µ–º —Ç–µ–Ω–¥–µ—Ä—ã
            setInterval(() => { updateStats(); }, 30000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
            setInterval(() => { updateIndicator(); }, 60000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
            setInterval(() => { loadTenders(); }, 120000); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–Ω–¥–µ—Ä–æ–≤ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω
        }
        
        initApp();
        
        // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    </script>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π -->
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç–µ–≥–æ–≤ -->
    <div id="tagsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üè∑Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞–º–∏</h2>
                <button class="modal-close" onclick="closeModal('tagsModal')">√ó</button>
            </div>
            <div id="currentTagsList" style="margin: 15px 0; min-height: 30px;"></div>
            <input type="text" id="newTagInput" class="modal-input" placeholder="–ù–æ–≤—ã–π —Ç–µ–≥..." onkeypress="if(event.key==='Enter') addTag()">
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal('tagsModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button onclick="addTag()">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π -->
    <div id="reminderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚è∞ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</h2>
                <button class="modal-close" onclick="closeModal('reminderModal')">√ó</button>
            </div>
            <p style="color: #aaa; margin-bottom: 10px;" id="reminderTenderTitle"></p>
            <p style="color: #ff9800; margin-bottom: 20px;" id="reminderDeadline"></p>
            <p style="margin-bottom: 15px;">–ù–∞–ø–æ–º–Ω–∏—Ç—å –∑–∞:</p>
            <div class="reminder-options">
                <label class="reminder-checkbox">
                    <input type="checkbox" value="1"> 1 –¥–µ–Ω—å
                </label>
                <label class="reminder-checkbox">
                    <input type="checkbox" value="3"> 3 –¥–Ω—è
                </label>
                <label class="reminder-checkbox">
                    <input type="checkbox" value="7"> 7 –¥–Ω–µ–π
                </label>
                <label class="reminder-checkbox">
                    <input type="checkbox" value="14"> 14 –¥–Ω–µ–π
                </label>
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal('reminderModal')">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="saveReminder()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- PWA Install Button -->
    <div id="installPWA" class="install-pwa" onclick="installPWA()">
        üì± –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    </div>

</body>
</html>
